<!DOCTYPE html>  <html> <head>   <title>commands.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="ace.html">                 ace.coffee               </a>                                           <a class="source" href="commands.html">                 commands.coffee               </a>                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="jim.html">                 jim.coffee               </a>                                           <a class="source" href="keymap.html">                 keymap.coffee               </a>                                           <a class="source" href="modes.html">                 modes.coffee               </a>                                           <a class="source" href="motions.html">                 motions.coffee               </a>                                           <a class="source" href="operators.html">                 operators.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               commands.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>All commands, other than operations and motions, live in here.  Commands can
be prefixed with a <code>count</code> which multiplies their action in some way. Commands
that define a <code>::visualExec</code> will be available in visual mode as well as
normal mode.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">repeatCountTimes</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./helpers&#39;</span>
<span class="p">{</span><span class="nx">Change</span><span class="p">,</span> <span class="nx">Delete</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./operators&#39;</span>
<span class="p">{</span><span class="nx">GoToLine</span><span class="p">,</span> <span class="nx">MoveDown</span><span class="p">,</span> <span class="nx">MoveLeft</span><span class="p">,</span> <span class="nx">MoveRight</span><span class="p">,</span> <span class="nx">MoveToEndOfLine</span><span class="p">,</span> <span class="nx">MoveToFirstNonBlank</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./motions&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The default key mappings are specified alongside the definitions of each command.
Accumulate the mappings so they can be exported.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">defaultMappings = </span><span class="p">{}</span>
<span class="nv">map = </span><span class="nf">(keys, commandClass) -&gt;</span> <span class="nx">defaultMappings</span><span class="p">[</span><span class="nx">keys</span><span class="p">]</span> <span class="o">=</span> <span class="nx">commandClass</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Define a convenience class for commands that switch to another mode.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ModeSwitch</span> <span class="k">extends</span> <span class="nx">Command</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span>
    <span class="nx">@beforeSwitch</span><span class="o">?</span> <span class="nx">jim</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">setMode</span> <span class="nx">@switchToMode</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>Visual mode switches</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Switch to characterwise visual mode.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">VisualSwitch</span> <span class="k">extends</span> <span class="nx">Command</span>
  <span class="nv">isRepeatable: </span><span class="kc">no</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span>
    <span class="nv">anchor = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">position</span><span class="p">()</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">setSelectionAnchor</span><span class="p">()</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">setMode</span> <span class="s1">&#39;visual&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">anchor</span><span class="p">}</span>
  <span class="nv">visualExec: </span><span class="nf">(jim) -&gt;</span>
    <span class="k">if</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">linewise</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">setMode</span> <span class="s1">&#39;visual&#39;</span><span class="p">,</span> <span class="nv">linewise: </span><span class="kc">no</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">setSelectionAnchor</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">anchor</span><span class="p">...</span>
    <span class="k">else</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">onEscape</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Switch to linewise visual mode.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">VisualLinewiseSwitch</span> <span class="k">extends</span> <span class="nx">Command</span>
  <span class="nv">isRepeatable: </span><span class="kc">no</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span>
    <span class="nv">anchor = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">setLinewiseSelectionAnchor</span><span class="p">()</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">setMode</span> <span class="s1">&#39;visual&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">linewise: </span><span class="kc">yes</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">}</span>
  <span class="nv">visualExec: </span><span class="nf">(jim) -&gt;</span>
    <span class="k">if</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">linewise</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">onEscape</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nv">modeState = linewise: </span><span class="kc">yes</span>
      <span class="nv">anchor = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">setLinewiseSelectionAnchor</span><span class="p">()</span>
      <span class="nv">modeState.anchor = </span><span class="nx">anchor</span> <span class="nx">unless</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">anchor</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">setMode</span> <span class="s1">&#39;visual&#39;</span><span class="p">,</span> <span class="nx">modeState</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Insert mode switches</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Insert before the char under the cursor.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">Insert</span> <span class="k">extends</span> <span class="nx">ModeSwitch</span>
  <span class="nv">switchToMode: </span><span class="s1">&#39;insert&#39;</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span>
    <span class="nx">@beforeSwitch</span><span class="o">?</span> <span class="nx">jim</span>
    <span class="k">if</span> <span class="nx">@repeatableInsert</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If <code>@repeatableInsert</code> is set, this call to <code>::exec</code> is to repeat the
insert. Don't switch to insert mode, just insert the text that was
inserted the first time.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">@repeatableInsert</span><span class="p">.</span><span class="nx">string</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>In order to inform the undo manager (which helps figures out what text to
insert when repeating an insert) when the insert is done doing whatever it
may have done before the switch to insert mode (e.g. deleted to the end of
the line in the case of <code>C</code>) and is switching to insert mode, a boolean is
set so the undo manager can bookmark that spot during the next keypress event</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">jim.afterInsertSwitch = </span><span class="kc">true</span>

      <span class="nx">jim</span><span class="p">.</span><span class="nx">setMode</span> <span class="nx">@switchToMode</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Insert after the char under the cursor.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">InsertAfter</span> <span class="k">extends</span> <span class="nx">Insert</span>
  <span class="nv">beforeSwitch: </span><span class="nf">(jim) -&gt;</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">moveRight</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Insert at the end of the line.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">InsertAtEndOfLine</span> <span class="k">extends</span> <span class="nx">Insert</span>
  <span class="nv">beforeSwitch: </span><span class="nf">(jim) -&gt;</span>
    <span class="k">new</span> <span class="nx">MoveToEndOfLine</span><span class="p">().</span><span class="nx">exec</span> <span class="nx">jim</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">moveRight</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Delete all remaining text on the line and insert in its place.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">ChangeToEndOfLine</span> <span class="k">extends</span> <span class="nx">Insert</span>
  <span class="nv">beforeSwitch: </span><span class="nf">(jim) -&gt;</span>
    <span class="k">new</span> <span class="nx">DeleteToEndOfLine</span><span class="p">(</span><span class="nx">@count</span><span class="p">).</span><span class="nx">exec</span> <span class="nx">jim</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Insert before to first non-blank char of the line.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">InsertBeforeFirstNonBlank</span> <span class="k">extends</span> <span class="nx">Insert</span>
  <span class="nv">beforeSwitch: </span><span class="nf">(jim) -&gt;</span> <span class="k">new</span> <span class="nx">MoveToFirstNonBlank</span><span class="p">().</span><span class="nx">exec</span> <span class="nx">jim</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Create a new line below the cursor and insert there.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">OpenLine</span> <span class="k">extends</span> <span class="nx">Insert</span>
  <span class="nv">beforeSwitch: </span><span class="nf">(jim) -&gt;</span>
    <span class="nv">row = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">row</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="k">if</span> <span class="nx">@above</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">insertNewLine</span> <span class="nx">row</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">row</span><span class="p">,</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Create a new line above the cursor and insert there.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">OpenLineAbove</span> <span class="k">extends</span> <span class="nx">OpenLine</span>
  <span class="nv">above: </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Replace the char under the cursor with an insert.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">ChangeChar</span> <span class="k">extends</span> <span class="nx">Insert</span>
  <span class="nv">beforeSwitch: </span><span class="nf">(jim) -&gt;</span> <span class="k">new</span> <span class="nx">DeleteChar</span><span class="p">(</span><span class="nx">@count</span><span class="p">).</span><span class="nx">exec</span> <span class="nx">jim</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>Replace mode switch</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">ReplaceSwitch</span> <span class="k">extends</span> <span class="nx">ModeSwitch</span>
  <span class="nv">beforeSwitch: </span><span class="nf">(jim) -&gt;</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">setOverwriteMode</span> <span class="kc">on</span>
  <span class="nv">switchToMode: </span><span class="s1">&#39;replace&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>Miscellaneous commands</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Join a line with the line following it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;gJ&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">JoinLines</span> <span class="k">extends</span> <span class="nx">Command</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span>
    <span class="nv">timesLeft = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">@count</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="nx">timesLeft</span><span class="o">--</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">selectLineEnding</span> <span class="nx">@normalize</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">deleteSelection</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">@normalize</span>
        <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">insert</span> <span class="s1">&#39; &#39;</span>
        <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>

  <span class="nv">visualExec: </span><span class="nf">(jim) -&gt;</span>
    <span class="p">[</span><span class="nx">minRow</span><span class="p">,</span> <span class="nx">maxRow</span><span class="p">]</span> <span class="o">=</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">selectionRowRange</span><span class="p">()</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">clearSelection</span><span class="p">()</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">minRow</span><span class="p">,</span> <span class="mi">0</span>
    <span class="vi">@count = </span><span class="nx">maxRow</span> <span class="o">-</span> <span class="nx">minRow</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nx">@exec</span> <span class="nx">jim</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">setMode</span> <span class="s1">&#39;normal&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Join a line with the line following it, ensuring that one space separates the
content from the lines.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">JoinLinesNormalizingWhitespace</span> <span class="k">extends</span> <span class="nx">JoinLines</span>
  <span class="nv">normalize: </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Delete all remaining text on the line.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">DeleteToEndOfLine</span> <span class="k">extends</span> <span class="nx">Command</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span> <span class="k">new</span> <span class="nx">Delete</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">new</span> <span class="nx">MoveToEndOfLine</span> <span class="nx">@count</span><span class="p">).</span><span class="nx">exec</span> <span class="nx">jim</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Paste after the cursor. Paste after the line if pasting linewise register.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">Paste</span> <span class="k">extends</span> <span class="nx">Command</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nv">registerValue = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">registers</span><span class="p">[</span><span class="s1">&#39;&quot;&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Using a count with <code>p</code> causes the pasted text to be repeated.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">text = </span><span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">@count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span> <span class="nx">registerValue</span>
    <span class="nv">linewiseRegister = </span><span class="sr">/\n$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">registerValue</span>
    <span class="k">if</span> <span class="nx">linewiseRegister</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Registers with linewise text in them (e.g. yanked with <code>yy</code> instead of <code>yw</code>,
for instance) are never pasted mid-line.  Move to the beginning of a line to
ensure this doesn't happen.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">row = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">row</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="k">if</span> <span class="nx">@before</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
      <span class="nv">lastRow = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">lastRow</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>If we're pasting row(s) after the last row, we have to move the line
ending to the begining of the string.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">row</span> <span class="o">&gt;</span> <span class="nx">lastRow</span>
        <span class="p">[</span><span class="nx">wholeString</span><span class="p">,</span> <span class="nx">beforeLineEnding</span><span class="p">,</span> <span class="nx">lineEnding</span><span class="p">]</span> <span class="o">=</span> <span class="sr">/^([\s\S]*)(\r?\n)$/</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">text</span>
        <span class="nv">text = </span><span class="nx">lineEnding</span> <span class="o">+</span> <span class="nx">beforeLineEnding</span>

        <span class="nv">column = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">lineText</span><span class="p">(</span><span class="nx">lastRow</span><span class="p">).</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">column</span>
      <span class="k">else</span>
        <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">row</span><span class="p">,</span> <span class="mi">0</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">text</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">row</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">else</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">text</span><span class="p">,</span> <span class="o">not</span> <span class="nx">@before</span>

  <span class="nv">visualExec: </span><span class="nf">(jim) -&gt;</span>
    <span class="k">if</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">linewise</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">makeLinewise</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">includeCursorInSelection</span><span class="p">()</span>
    <span class="nv">overwrittenText = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">deleteSelection</span><span class="p">()</span>
    <span class="vi">@before = </span><span class="kc">true</span>
    <span class="nx">@exec</span> <span class="nx">jim</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">registers</span><span class="p">[</span><span class="s1">&#39;&quot;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">overwrittenText</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">setMode</span> <span class="s1">&#39;normal&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Paste before the cursor. Paste before the line if pasting linewise register.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">PasteBefore</span> <span class="k">extends</span> <span class="nx">Paste</span>
  <span class="nv">before: </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Replace the char under the cursor with the char pressed after <code>r</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">ReplaceChar</span> <span class="k">extends</span> <span class="nx">Command</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Match <code>[\s\S]</code> so that it will match <code>\n</code> (windows' <code>\r\n</code>?)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@followedBy: </span><span class="sr">/[\s\S]+/</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">setSelectionAnchor</span><span class="p">()</span>
    <span class="k">new</span> <span class="nx">MoveRight</span><span class="p">(</span><span class="nx">@count</span><span class="p">).</span><span class="nx">exec</span> <span class="nx">jim</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">deleteSelection</span><span class="p">()</span> <span class="c1"># don&#39;t yank</span>
    <span class="nv">replacementText = </span><span class="k">if</span> <span class="sr">/^\r?\n$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">@followedBy</span>
      <span class="nx">@followedBy</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">@count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span> <span class="nx">@followedBy</span>
    <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">replacementText</span>
    <span class="k">new</span> <span class="nx">MoveLeft</span><span class="p">().</span><span class="nx">exec</span> <span class="nx">jim</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Repeat the last repeatable command.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">RepeatCommand</span> <span class="k">extends</span> <span class="nx">Command</span>
  <span class="nv">isRepeatable: </span><span class="kc">no</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span>
    <span class="nv">command = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">lastCommand</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">command</span>

    <span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">switchToMode</span> <span class="o">is</span> <span class="s1">&#39;insert&#39;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;command.repeatableInsert&#39;</span><span class="p">,</span> <span class="nx">command</span><span class="p">.</span><span class="nx">repeatableInsert</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>For an insert that wasn't contiguous (i.e. the user moved the cursor
partway through the insert), Vim repeats it as a standard <code>i</code> insert
with just the last contigous piece of text.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">command</span><span class="p">.</span><span class="nx">repeatableInsert</span><span class="p">.</span><span class="nx">contiguous</span>
        <span class="p">{</span><span class="nx">string</span><span class="p">}</span> <span class="o">=</span> <span class="nx">command</span><span class="p">.</span><span class="nx">repeatableInsert</span>
        <span class="nv">command = </span><span class="k">new</span> <span class="nx">Insert</span><span class="p">()</span>
        <span class="nv">command.repeatableInsert = </span><span class="p">{</span><span class="nx">string</span><span class="p">}</span>

    <span class="k">if</span> <span class="nv">selectionSize = </span><span class="nx">command</span><span class="p">.</span><span class="nx">selectionSize</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>If we're repeating a command made in visual mode, it should affect the
same "amount" of text by using motions to move over the same aomount
of text</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">selectionSize</span><span class="p">.</span><span class="nx">lines</span>
        <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">makeLinewise</span> <span class="nx">selectionSize</span><span class="p">.</span><span class="nx">lines</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">selectionSize</span><span class="p">.</span><span class="nx">chars</span>
        <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">setSelectionAnchor</span><span class="p">()</span>
        <span class="k">new</span> <span class="nx">MoveRight</span><span class="p">(</span><span class="nx">selectionSize</span><span class="p">.</span><span class="nx">chars</span><span class="p">).</span><span class="nx">exec</span> <span class="nx">jim</span>
      <span class="k">else</span>
        <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">setSelectionAnchor</span><span class="p">()</span>
        <span class="nv">row = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">row</span><span class="p">()</span> <span class="o">+</span> <span class="nx">selectionSize</span><span class="p">.</span><span class="nx">lineEndings</span>
        <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">selectionSize</span><span class="p">.</span><span class="nx">trailingChars</span> <span class="o">-</span> <span class="mi">1</span>

      <span class="nx">command</span><span class="p">.</span><span class="nx">visualExec</span> <span class="nx">jim</span>

    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>TODO count should replace the lastCommand's count</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">command</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">jim</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Undo the last command that modified the document.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">Undo</span> <span class="k">extends</span> <span class="nx">Command</span>
  <span class="nv">isRepeatable: </span><span class="kc">no</span>
  <span class="nv">exec: </span><span class="nx">repeatCountTimes</span> <span class="nf">(jim) -&gt;</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">undo</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Delete the char under the cursor.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">DeleteChar</span> <span class="k">extends</span> <span class="nx">Command</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span> <span class="k">new</span> <span class="nx">Delete</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">new</span> <span class="nx">MoveRight</span> <span class="nx">@count</span><span class="p">).</span><span class="nx">exec</span> <span class="nx">jim</span>
  </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Delete the char before the cursor.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">map</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="k">class</span> <span class="nx">Backspace</span> <span class="k">extends</span> <span class="nx">Command</span>
  <span class="nv">exec: </span><span class="nf">(jim) -&gt;</span> <span class="k">new</span> <span class="nx">Delete</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">new</span> <span class="nx">MoveLeft</span> <span class="nx">@count</span><span class="p">).</span><span class="nx">exec</span> <span class="nx">jim</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h2>Exports</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = </span><span class="p">{</span><span class="nx">defaultMappings</span><span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 