<!DOCTYPE html>  <html> <head>   <title>ace.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="ace.html">                 ace.coffee               </a>                                           <a class="source" href="commands.html">                 commands.coffee               </a>                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="jim.html">                 jim.coffee               </a>                                           <a class="source" href="keymap.html">                 keymap.coffee               </a>                                           <a class="source" href="modes.html">                 modes.coffee               </a>                                           <a class="source" href="motions.html">                 motions.coffee               </a>                                           <a class="source" href="operators.html">                 operators.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               ace.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>All of Jim's Ace-specific code is in here.  The idea is that an <code>Adaptor</code> for
another editor could be written that implemented the same methods and presto!
Jim works in that editor, too!  It's probably not that simple, but we'll find
out... patches welcome :)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">UndoManager</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;ace/undomanager&#39;</span>
<span class="nv">Jim           = </span><span class="nx">require</span> <span class="s1">&#39;./jim&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Ace's editor adaptor</h2>

<p>Each instance of <code>Jim</code> has an instance of an <code>Adaptor</code> on which it invokes
methods to move the cursor, change some text, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Adaptor</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Constuct an <code>Adaptor</code> with instance of Ace's <code>Editor</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@editor) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Return true if the cursor is on or beyond the last character of the line. If
<code>beyond</code> is true, return true only if the cursor is beyond the last char.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">atLineEnd = </span><span class="nf">(editor, beyond) -&gt;</span>
    <span class="nv">selectionLead = </span><span class="nx">editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">getSelectionLead</span><span class="p">()</span>
    <span class="nv">lineLength = </span><span class="nx">editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">selectionLead</span><span class="p">.</span><span class="nx">row</span><span class="p">).</span><span class="nx">length</span>
    <span class="nx">selectionLead</span><span class="p">.</span><span class="nx">column</span> <span class="o">&gt;=</span> <span class="nx">lineLength</span> <span class="o">-</span> <span class="p">(</span><span class="k">if</span> <span class="nx">beyond</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

  <span class="nv">beyondLineEnd = </span><span class="nf">(editor) -&gt;</span> <span class="nx">atLineEnd</span><span class="p">(</span><span class="nx">editor</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Whenever Jim's mode changes, update the editor's <code>className</code> and push a
"bookmark" onto the undo stack, if needed (explained below).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onModeChange: </span><span class="nf">(prevMode, newMode) -&gt;</span>
    <span class="k">for</span> <span class="nx">mode</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;visual&#39;</span><span class="p">]</span>
      <span class="nx">@editor</span><span class="p">[</span><span class="k">if</span> <span class="nx">mode</span> <span class="o">is</span> <span class="nx">newMode</span><span class="p">.</span><span class="nx">name</span> <span class="k">then</span> <span class="s1">&#39;setStyle&#39;</span> <span class="k">else</span> <span class="s1">&#39;unsetStyle&#39;</span><span class="p">]</span> <span class="s2">&quot;jim-#{mode}-mode&quot;</span>

    <span class="nx">@editor</span><span class="p">[</span><span class="k">if</span> <span class="nx">newMode</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;visual&#39;</span> <span class="o">and</span> <span class="nx">newMode</span><span class="p">.</span><span class="nx">linewise</span> <span class="k">then</span> <span class="s1">&#39;setStyle&#39;</span> <span class="k">else</span> <span class="s1">&#39;unsetStyle&#39;</span><span class="p">]</span> <span class="s1">&#39;jim-visual-linewise-mode&#39;</span>

    <span class="k">if</span> <span class="nx">newMode</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;insert&#39;</span>
      <span class="nx">@markUndoPoint</span> <span class="s1">&#39;jim:insert:start&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">prevMode</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;insert&#39;</span>
      <span class="nx">@markUndoPoint</span> <span class="s1">&#39;jim:insert:end&#39;</span>

    <span class="k">if</span> <span class="nx">newMode</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;replace&#39;</span>
      <span class="nx">@markUndoPoint</span> <span class="s1">&#39;jim:replace:start&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">prevMode</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;replace&#39;</span>
      <span class="nx">@markUndoPoint</span> <span class="s1">&#39;jim:replace:end&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Vim's undo is particularly useful because it's idea of an atomic edit is
clear to the user.  One <code>Command</code> is undone each time <code>u</code> is pressed.  That
means all text entered between hitting <code>i</code> and hitting <code>&lt;esc&gt;</code> is undone as
one atomic edit.</p>

<p>To match Vim's undo granularity, Jim pushes "bookmarks" onto the undo stack
to indicate when an insert starts or ends, for example.  This helps us avoid
having to record all keystrokes made while in insert or replace mode.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">markUndoPoint: </span><span class="nf">(markName) -&gt;</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">getUndoManager</span><span class="p">().</span><span class="nx">execute</span> <span class="nv">args: </span><span class="p">[</span><span class="nx">markName</span><span class="p">,</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Turns overwrite mode on or off (used for Jim's replace mode).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setOverwriteMode: </span><span class="nf">(active) -&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">setOverwrite</span> <span class="nx">active</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Clears the selection, optionally positioning the cursor at its beginning.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clearSelection: </span><span class="nf">(beginning) -&gt;</span>
    <span class="k">if</span> <span class="nx">beginning</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">isBackwards</span><span class="p">()</span>
      <span class="p">{</span><span class="nx">row</span><span class="p">,</span> <span class="nx">column</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">getSelectionAnchor</span><span class="p">()</span>
      <span class="nx">@editor</span><span class="p">.</span><span class="nx">navigateTo</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">column</span>
    <span class="k">else</span>
      <span class="nx">@editor</span><span class="p">.</span><span class="nx">clearSelection</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Undo the last <code>Command</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">undo: </span><span class="o">-&gt;</span>
    <span class="nv">undoManager = </span><span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">getUndoManager</span><span class="p">()</span>
    <span class="nx">undoManager</span><span class="p">.</span><span class="nx">jimUndo</span><span class="p">()</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">clearSelection</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Get information about the last insert <code>Command</code>. See
<code>JimUndoManager::lastInsert</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">lastInsert: </span><span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">getUndoManager</span><span class="p">().</span><span class="nx">lastInsert</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Define methods for getting the cursor's position in the document.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">column: </span>  <span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">selectionLead</span><span class="p">.</span><span class="nx">column</span>
  <span class="nv">row: </span>     <span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">selectionLead</span><span class="p">.</span><span class="nx">row</span>
  <span class="nv">position: </span><span class="o">-&gt;</span> <span class="p">[</span><span class="nx">@row</span><span class="p">(),</span> <span class="nx">@column</span><span class="p">()]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Return the first row that is fully visible in the viewport.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">firstFullyVisibleRow: </span><span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">getFirstFullyVisibleRow</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Return the last row in the document that is fully visible in the viewport.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">lastFullyVisibleRow: </span> <span class="o">-&gt;</span>
    <span class="nv">lastVisibleRow = </span><span class="nx">@editor</span><span class="p">.</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">getLastFullyVisibleRow</span><span class="p">()</span>
    <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">@lastRow</span><span class="p">(),</span> <span class="nx">lastVisibleRow</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Before we act on a non-backwards selection, Jim's block cursor is not
considered by Ace to be part of the selection.  Make the cursor part of the
selection before we act on it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">includeCursorInSelection: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">isBackwards</span><span class="p">()</span>
      <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">selectRight</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">beyondLineEnd</span><span class="p">(</span><span class="nx">@editor</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Insert a new line at a zero-based row number.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">insertNewLine: </span><span class="nf">(row) -&gt;</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">insertNewLine</span> <span class="nv">row: </span><span class="nx">row</span><span class="p">,</span> <span class="nv">column: </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Move the anchor by <code>columnOffset</code> columns, which can be negative.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">adjustAnchor: </span><span class="nf">(columnOffset) -&gt;</span>
    <span class="p">{</span><span class="nx">row</span><span class="p">,</span> <span class="nx">column</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">getSelectionAnchor</span><span class="p">()</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">setSelectionAnchor</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">column</span> <span class="o">+</span> <span class="nx">columnOffset</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Is the anchor ahead of the cursor?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isSelectionBackwards: </span><span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">isBackwards</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Return the last zero-based row number.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">lastRow: </span><span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">getDocument</span><span class="p">().</span><span class="nx">getLength</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Return the text that's on <code>lineNumber</code> or the current line.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">lineText: </span><span class="nf">(lineNumber) -&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">getLine</span> <span class="nx">lineNumber</span> <span class="o">?</span> <span class="nx">@row</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Make a linewise selection <code>lines</code> long if specified or make the current
selection linewise by pushing the lead and the anchor to the ends of their
lines.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeLinewise: </span><span class="nf">(lines) -&gt;</span>
    <span class="p">{</span><span class="nv">selectionAnchor: </span><span class="p">{</span><span class="nv">row: </span><span class="nx">anchorRow</span><span class="p">},</span> <span class="nv">selectionLead: </span><span class="p">{</span><span class="nv">row: </span><span class="nx">leadRow</span><span class="p">}}</span> <span class="o">=</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span>
    <span class="p">[</span><span class="nx">firstRow</span><span class="p">,</span> <span class="nx">lastRow</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">lines</span><span class="o">?</span>
      <span class="p">[</span><span class="nx">leadRow</span><span class="p">,</span> <span class="nx">leadRow</span> <span class="o">+</span> <span class="p">(</span><span class="nx">lines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">else</span>
      <span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">anchorRow</span><span class="p">,</span> <span class="nx">leadRow</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">anchorRow</span><span class="p">,</span> <span class="nx">leadRow</span><span class="p">)]</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">setSelectionAnchor</span> <span class="nx">firstRow</span><span class="p">,</span> <span class="mi">0</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">moveCursorTo</span> <span class="nx">lastRow</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Define basic directional movements. These won't clear the selection.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveUp: </span>  <span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">moveCursorBy</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
  <span class="nv">moveDown: </span><span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">moveCursorBy</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
  <span class="nv">moveLeft: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">selectionLead</span><span class="p">.</span><span class="nx">getPosition</span><span class="p">().</span><span class="nx">column</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">moveCursorLeft</span><span class="p">()</span>
  <span class="nv">moveRight: </span><span class="nf">(beyond) -&gt;</span>
    <span class="nv">dontMove = </span><span class="k">if</span> <span class="nx">beyond</span> <span class="k">then</span> <span class="nx">beyondLineEnd</span><span class="p">(</span><span class="nx">@editor</span><span class="p">)</span> <span class="k">else</span> <span class="nx">atLineEnd</span><span class="p">(</span><span class="nx">@editor</span><span class="p">)</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">moveCursorRight</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">dontMove</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Move to a zero-based <code>row</code> and <code>column</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveTo: </span><span class="nf">(row, column) -&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">moveCursorTo</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">column</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Put the cursor on the last column of the line.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveToLineEnd: </span><span class="o">-&gt;</span>
    <span class="p">{</span><span class="nx">row</span><span class="p">,</span> <span class="nx">column</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">selectionLead</span>
    <span class="nv">position = </span><span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">getDocumentLastRowColumnPosition</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">column</span>
    <span class="nx">@moveTo</span> <span class="nx">position</span><span class="p">.</span><span class="nx">row</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">column</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="nv">moveToEndOfPreviousLine: </span><span class="o">-&gt;</span>
    <span class="nv">previousRow = </span><span class="nx">@row</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nv">previousRowLength = </span><span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">previousRow</span><span class="p">).</span><span class="nx">length</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">moveCursorTo</span> <span class="nx">previousRow</span><span class="p">,</span> <span class="nx">previousRowLength</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Move to first or last line.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">navigateFileEnd: </span>  <span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">navigateFileEnd</span><span class="p">()</span>
  <span class="nv">navigateLineStart: </span><span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">navigateLineStart</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Move the cursor to the fist char of the matching search or don't move at
all.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">search: </span><span class="nf">(backwards, needle, wholeWord) -&gt;</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">$search</span><span class="p">.</span><span class="nx">set</span> <span class="p">{</span><span class="nx">backwards</span><span class="p">,</span> <span class="nx">needle</span><span class="p">,</span> <span class="nx">wholeWord</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Move the cursor right so that it won't match what's already under the
cursor.  Move the cursor back afterwards if nothing's found.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">moveCursorRight</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">backwards</span>

    <span class="k">if</span> <span class="nv">range = </span><span class="nx">@editor</span><span class="p">.</span><span class="nx">$search</span><span class="p">.</span><span class="nx">find</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span>
      <span class="nx">@moveTo</span> <span class="nx">range</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">row</span><span class="p">,</span> <span class="nx">range</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">column</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">backwards</span>
      <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">moveCursorLeft</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Delete selected text and return it as a string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">deleteSelection: </span><span class="o">-&gt;</span>
    <span class="nv">yank = </span><span class="nx">@editor</span><span class="p">.</span><span class="nx">getCopyText</span><span class="p">()</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">getSelectionRange</span><span class="p">()</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">clearSelection</span><span class="p">()</span>
    <span class="nx">yank</span>

  <span class="nv">indentSelection: </span><span class="o">-&gt;</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">indent</span><span class="p">()</span>
    <span class="nx">@clearSelection</span><span class="p">()</span>

  <span class="nv">outdentSelection: </span><span class="o">-&gt;</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">blockOutdent</span><span class="p">()</span>
    <span class="nx">@clearSelection</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Insert <code>text</code> before or after the cursor.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">insert: </span><span class="nf">(text, after) -&gt;</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">moveCursorRight</span><span class="p">()</span> <span class="k">if</span> <span class="nx">after</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">beyondLineEnd</span><span class="p">(</span><span class="nx">@editor</span><span class="p">)</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">text</span> <span class="k">if</span> <span class="nx">text</span>

  <span class="nv">emptySelection: </span><span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>

  <span class="nv">selectionText: </span><span class="o">-&gt;</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">getCopyText</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Set the selection anchor to the cusor's current position.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setSelectionAnchor: </span><span class="o">-&gt;</span>
    <span class="nv">lead = </span><span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">selectionLead</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">setSelectionAnchor</span> <span class="nx">lead</span><span class="p">.</span><span class="nx">row</span><span class="p">,</span> <span class="nx">lead</span><span class="p">.</span><span class="nx">column</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Jim's linewise selections are really just regular selections with a CSS
width of <code>100%</code>.  Before a visual command is exececuted the selection is
actually made linewise.  Because of this, it only matters what line the
anchor is on.  Therefore, we "hide" the anchor at the end of the line
where Jim's cursor won't go so that Ace doesn't remove the selection
elements from the DOM (which happens when the cursor and the anchor are
in the same place).  It's a wierd hack, but it works.  There was a
<a href="https://github.com/misfo/jim/issues/5">github issue</a> for this.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setLinewiseSelectionAnchor: </span><span class="o">-&gt;</span>
    <span class="p">{</span><span class="nx">selection</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@editor</span>
    <span class="p">{</span><span class="nx">row</span><span class="p">,</span> <span class="nx">column</span><span class="p">}</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">[</span><span class="k">if</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span> <span class="k">then</span> <span class="s1">&#39;selectionLead&#39;</span> <span class="k">else</span> <span class="s1">&#39;selectionAnchor&#39;</span><span class="p">]</span>
    <span class="nv">lastColumn = </span><span class="nx">@editor</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">getDocumentLastRowColumnPosition</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">column</span>
    <span class="nx">selection</span><span class="p">.</span><span class="nx">setSelectionAnchor</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">lastColumn</span>
    <span class="p">[</span><span class="nx">row</span><span class="p">,</span> <span class="nx">column</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Select the line ending at the end of the current line and any whitespace at
the beginning of the next line if <code>andFollowingWhitespace</code> is specified.
This is used for the line joining commands <code>gJ</code> and <code>J</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">selectLineEnding: </span><span class="nf">(andFollowingWhitespace) -&gt;</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">moveCursorLineEnd</span><span class="p">()</span>
    <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">selectRight</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">andFollowingWhitespace</span>
      <span class="nv">firstNonBlank = </span><span class="sr">/\S/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">@lineText</span><span class="p">())</span><span class="o">?</span><span class="p">.</span><span class="nx">index</span> <span class="o">or</span> <span class="mi">0</span>
      <span class="nx">@moveTo</span> <span class="nx">@row</span><span class="p">(),</span> <span class="nx">firstNonBlank</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Return the first and the last line that are part of the current selection.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">selectionRowRange: </span><span class="o">-&gt;</span>
    <span class="p">[</span><span class="nx">cursorRow</span><span class="p">,</span> <span class="nx">cursorColumn</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@position</span><span class="p">()</span>
    <span class="p">{</span><span class="nv">row: </span><span class="nx">anchorRow</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">getSelectionAnchor</span><span class="p">()</span>
    <span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">cursorRow</span><span class="p">,</span> <span class="nx">anchorRow</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">cursorRow</span><span class="p">,</span> <span class="nx">anchorRow</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Return the number of chars selected if the selection is one row. If the
selection is multiple rows, return the number of line endings selected
and the number of chars selected on the last row of the selection.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">characterwiseSelectionSize: </span><span class="o">-&gt;</span>
    <span class="p">{</span><span class="nx">selectionAnchor</span><span class="p">,</span> <span class="nx">selectionLead</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">selection</span>
    <span class="nv">rowsDown = </span><span class="nx">selectionLead</span><span class="p">.</span><span class="nx">row</span> <span class="o">-</span> <span class="nx">selectionAnchor</span><span class="p">.</span><span class="nx">row</span>
    <span class="k">if</span> <span class="nx">rowsDown</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nv">chars: </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">selectionAnchor</span><span class="p">.</span><span class="nx">column</span> <span class="o">-</span> <span class="nx">selectionLead</span><span class="p">.</span><span class="nx">column</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">lineEndings: </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">rowsDown</span><span class="p">)</span>
      <span class="nv">trailingChars: </span><span class="p">(</span><span class="k">if</span> <span class="nx">rowsDown</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">selectionLead</span> <span class="k">else</span> <span class="nx">selectionAnchor</span><span class="p">).</span><span class="nx">column</span> <span class="o">+</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h2>Jim's undo manager</h2>

<p>Ace's <code>UndoManager</code> is extended to handle undoing and repeating switches to
insert and replace mode.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">JimUndoManager</span> <span class="k">extends</span> <span class="nx">UndoManager</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Override Ace's default <code>undo</code> so that the default undo button and keyboard
shortcut will skip over Jim's bookmarks and behave as they usually do.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">undo: </span><span class="o">-&gt;</span>
    <span class="nx">@silentUndo</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@isJimMark</span> <span class="nx">@lastOnUndoStack</span><span class="p">()</span>
    <span class="k">super</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Is this a bookmark we pushed onto the stack or an actual Ace undo entry?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isJimMark: </span><span class="nf">(entry) -&gt;</span>
    <span class="k">typeof</span> <span class="nx">entry</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span> <span class="o">and</span> <span class="sr">/^jim:/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">entry</span>

  <span class="nv">lastOnUndoStack: </span><span class="o">-&gt;</span> <span class="nx">@$undoStack</span><span class="p">[</span><span class="nx">@$undoStack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Pop the item off the stack without doing anything with it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">silentUndo: </span><span class="o">-&gt;</span>
    <span class="nv">deltas = </span><span class="nx">@$undoStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="nx">@$redoStack</span><span class="p">.</span><span class="nx">push</span> <span class="nx">deltas</span> <span class="k">if</span> <span class="nx">deltas</span>

  <span class="nv">matchingMark:</span>
    <span class="s1">&#39;jim:insert:end&#39;</span><span class="o">:</span>  <span class="s1">&#39;jim:insert:start&#39;</span>
    <span class="s1">&#39;jim:replace:end&#39;</span><span class="o">:</span> <span class="s1">&#39;jim:replace:start&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>If the last command was an insert or a replace ensure that all undo items
associated with that command are undone.  If not, just do a regular ace
undo.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">jimUndo: </span><span class="o">-&gt;</span>
    <span class="nv">lastDeltasOnStack = </span><span class="nx">@lastOnUndoStack</span><span class="p">()</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">lastDeltasOnStack</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span> <span class="o">and</span> <span class="nv">startMark = </span><span class="nx">@matchingMark</span><span class="p">[</span><span class="nx">lastDeltasOnStack</span><span class="p">]</span>
      <span class="nv">startIndex = </span><span class="kc">null</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">@$undoStack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)..</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">@$undoStack</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">is</span> <span class="nx">startMark</span>
          <span class="nv">startIndex = </span><span class="nx">i</span>
          <span class="k">break</span>

      <span class="k">if</span> <span class="o">not</span> <span class="nx">startIndex</span><span class="o">?</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;found a \&quot;#{lastDeltasOnStack}\&quot; on the undoStack, but no \&quot;#{startMark}\&quot;&quot;</span>
        <span class="k">return</span>

      <span class="nx">@silentUndo</span><span class="p">()</span> <span class="c1"># pop the end off</span>
      <span class="k">while</span> <span class="nx">@$undoStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">startIndex</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nx">@isJimMark</span> <span class="nx">@lastOnUndoStack</span><span class="p">()</span>
          <span class="nx">@silentUndo</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="nx">@undo</span><span class="p">()</span>
      <span class="nx">@silentUndo</span><span class="p">()</span> <span class="c1"># pop the start off</span>
    <span class="k">else</span>
      <span class="nx">@undo</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>If the last command was an insert, return all text that was inserted taking
backspaces into account.</p>

<p>If the cursor moved partway through the insert (with arrow keys or with the
mouse), then only the last peice of contiguously inserted text is returned
and <code>contiguous</code> is returned as <code>false</code>.  This is to match Vim's behavior
when repeating non-contiguous inserts.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">lastInsert: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nx">@lastOnUndoStack</span><span class="p">()</span> <span class="o">isnt</span> <span class="s1">&#39;jim:insert:end&#39;</span>

    <span class="nv">cursorPosInsert = </span><span class="kc">null</span>
    <span class="nv">cursorPosRemove = </span><span class="kc">null</span>
    <span class="nv">action = </span><span class="kc">null</span>
    <span class="nv">stringParts = </span><span class="p">[]</span>
    <span class="nv">removedParts = </span><span class="p">[]</span>
    <span class="nv">isContiguous = </span><span class="nf">(delta) -&gt;</span>
      <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="sr">/(insert|remove)/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">action</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">action</span> <span class="o">or</span> <span class="nx">action</span> <span class="o">is</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">action</span>
        <span class="k">if</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;insertText&#39;</span>
          <span class="o">not</span> <span class="nx">cursorPosInsert</span> <span class="o">or</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">isEnd</span> <span class="nx">cursorPosInsert</span><span class="p">...</span>
        <span class="k">else</span>
          <span class="o">not</span> <span class="nx">cursorPosRemove</span> <span class="o">or</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">isStart</span> <span class="nx">cursorPosRemove</span><span class="p">...</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;insertText&#39;</span> <span class="o">and</span> <span class="nx">cursorPosInsert</span><span class="o">?</span>
          <span class="nx">delta</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">row</span> <span class="o">is</span> <span class="nx">cursorPosInsert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;removeText&#39;</span> <span class="o">and</span> <span class="nx">cursorPosRemove</span><span class="o">?</span>
          <span class="nx">delta</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">row</span> <span class="o">is</span> <span class="nx">cursorPosRemove</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="kc">true</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">@$undoStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)..</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">break</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@$undoStack</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
      <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">@$undoStack</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)..</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">@$undoStack</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">].</span><span class="nx">deltas</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)..</span><span class="mi">0</span><span class="p">]</span>
          <span class="nv">delta = </span><span class="nx">@$undoStack</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">].</span><span class="nx">deltas</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
          <span class="k">if</span> <span class="nx">isContiguous</span><span class="p">(</span><span class="nx">delta</span><span class="p">)</span>
            <span class="nv">action = </span><span class="nx">delta</span><span class="p">.</span><span class="nx">action</span>
            <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;removeText&#39;</span>
              <span class="nv">cursorPosRemove = </span><span class="p">[</span><span class="nx">delta</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">row</span><span class="p">,</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span>
              <span class="k">for</span> <span class="nx">text</span> <span class="k">in</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nx">removedParts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">text</span>

            <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;insertText&#39;</span>
              <span class="nv">cursorPosInsert = </span><span class="p">[</span><span class="nx">delta</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">row</span><span class="p">,</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span>
              <span class="k">continue</span> <span class="k">if</span> <span class="nx">removedParts</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">text</span> <span class="o">is</span> <span class="nx">removedParts</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
              <span class="k">for</span> <span class="nx">text</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">delta</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)..</span><span class="mi">0</span><span class="p">]</span>
                <span class="nx">stringParts</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">delta</span><span class="p">.</span><span class="nx">text</span><span class="p">[</span><span class="nx">text</span><span class="p">]</span>
          <span class="k">else</span>
            <span class="k">return</span> <span class="nv">string: </span><span class="nx">stringParts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nv">contiguous: </span><span class="kc">false</span>
    <span class="nv">string: </span><span class="nx">stringParts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nv">contiguous: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h2>Cursor and selection styles</h2>

<p>Make Ace's cursor be block-style when Jim is in normal mode and make
selections span the editor's entire width when in linewise visual mode.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pilot/dom&#39;</span><span class="p">).</span><span class="nx">importCssString</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  .jim-normal-mode div.ace_cursor</span>
<span class="s2">  , .jim-visual-mode div.ace_cursor {</span>
<span class="s2">    border: 0;</span>
<span class="s2">    background-color: #91FF00;</span>
<span class="s2">    opacity: 0.5;</span>
<span class="s2">  }</span>
<span class="s2">  .jim-visual-linewise-mode .ace_marker-layer .ace_selection {</span>
<span class="s2">    left: 0 !important;</span>
<span class="s2">    width: 100% !important;</span>
<span class="s2">  }</span>
<span class="s2">&quot;&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <h2>Hooking into Ace</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Is the keyboard event a printable character key?</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">isCharacterKey = </span><span class="nf">(hashId, keyCode) -&gt;</span> <span class="nx">hashId</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">keyCode</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Set up Jim to handle the Ace <code>editor</code>'s keyboard events.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Jim.aceInit = </span><span class="nf">(editor) -&gt;</span>
  <span class="nx">editor</span><span class="p">.</span><span class="nx">setKeyboardHandler</span>
    <span class="nv">handleKeyboard: </span><span class="nf">(data, hashId, keyString, keyCode) -&gt;</span>
      <span class="k">if</span> <span class="nx">keyCode</span> <span class="o">is</span> <span class="mi">27</span> <span class="c1"># esc</span>
        <span class="nx">jim</span><span class="p">.</span><span class="nx">onEscape</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">isCharacterKey</span> <span class="nx">hashId</span><span class="p">,</span> <span class="nx">keyCode</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>We've made some deletion as part of a change operation already and
we're about to start the actual insert.  Mark this moment in the undo
stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">afterInsertSwitch</span>
          <span class="k">if</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;insert&#39;</span>
            <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">markUndoPoint</span> <span class="s1">&#39;jim:insert:afterSwitch&#39;</span>
          <span class="nv">jim.afterInsertSwitch = </span><span class="kc">false</span>

        <span class="k">if</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;normal&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">jim</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">emptySelection</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>If a selection has been made with the mouse since the last
keypress in normal mode, switch to visual mode.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">jim</span><span class="p">.</span><span class="nx">setMode</span> <span class="s1">&#39;visual&#39;</span>

        <span class="k">if</span> <span class="nx">keyString</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>TODO handle this better, we're dropping keypresses here</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">keyString = </span><span class="nx">keyString</span><span class="p">.</span><span class="nx">charAt</span> <span class="mi">0</span>

        <span class="nv">passKeypressThrough = </span><span class="nx">jim</span><span class="p">.</span><span class="nx">onKeypress</span> <span class="nx">keyString</span>

        <span class="k">if</span> <span class="o">not</span> <span class="nx">passKeypressThrough</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Prevent Ace's default handling of the event.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">command: </span><span class="p">{</span><span class="nv">exec: </span><span class="p">(</span><span class="o">-&gt;</span><span class="p">)}</span>

  <span class="nv">undoManager = </span><span class="k">new</span> <span class="nx">JimUndoManager</span><span class="p">()</span>
  <span class="nx">editor</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">setUndoManager</span> <span class="nx">undoManager</span>

  <span class="nv">adaptor = </span><span class="k">new</span> <span class="nx">Adaptor</span> <span class="nx">editor</span>
  <span class="nv">jim = </span><span class="k">new</span> <span class="nx">Jim</span> <span class="nx">adaptor</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Initialize the editor element's <code>className</code>s.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">adaptor</span><span class="p">.</span><span class="nx">onModeChange</span> <span class="kc">null</span><span class="p">,</span> <span class="nv">name: </span><span class="s1">&#39;normal&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Return <code>jim</code> in case embedders wanna inspect its state or give it a high
five.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">jim</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 